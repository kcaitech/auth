# 谷歌登录和微信登录的测试方法

## 谷歌登录测试

### 1. 开发环境测试

1. **配置 Google OAuth 凭证**：
   ```
   - 确保 server/auth/google_login.go 中的 ClientID 和 ClientSecret 正确配置
   - 同时确保前端 Login.vue 和 auth.ts 中的 client_id 也已正确配置
   ```

2. **设置回调 URL**：
   ```
   - 在 Google 开发者控制台中配置你的开发环境回调 URL（如 http://localhost:8080/auth/google/callback）
   - 确保与代码中的 RedirectURL 保持一致
   ```

3. **使用测试账号**：
   ```
   - 使用自己的 Google 账号进行测试
   - 或在 Google 开发者控制台中添加特定的测试账号（适用于敏感应用）
   ```

4. **代码调试**：
   ```
   - 在 GoogleLogin 和 GoogleCallback 处理函数中设置断点
   - 监控网络请求，特别是与 Google API 的交互
   - 检查返回的 token 和用户信息
   ```

5. **常见问题排查**：
   ```
   - 检查浏览器控制台的 JavaScript 错误
   - 查看网络请求的响应状态码和内容
   - 验证 state 参数是否正确传递和验证
   ```

### 2. 生产环境模拟测试

1. **使用测试域名**：
   ```
   - 配置一个与生产环境相似但独立的测试域名
   - 在 Google 开发者控制台中添加该域名作为授权来源和回调 URL
   ```

2. **真实场景测试**：
   ```
   - 使用不同设备和浏览器测试
   - 测试弱网络条件下的登录流程
   - 验证登录后的状态保持和会话管理
   ```

## 微信登录测试

### 1. 开发环境测试

1. **配置微信开发者账号**：
   ```
   - 确保已在微信开放平台注册并获取了 AppID 和 AppSecret
   - 配置 server/auth/weixin_login.go 中的对应参数
   ```

2. **设置回调域名**：
   ```
   - 在微信开放平台配置授权回调域名
   - 由于微信对回调域名有严格要求，可能需要使用代理或临时域名
   ```

3. **构建测试环境**：
   ```
   - 由于微信要求回调域名必须是已备案的域名，开发环境测试需要使用代理
   - 可以使用 ngrok 或其他工具将本地服务器暴露到公网
   ```

4. **调试流程**：
   ```
   - 在微信登录的 WeixinLoginURL 和 WeixinCallback 函数中添加详细日志
   - 监控微信返回的授权码和 state 参数
   - 验证微信回调地址的访问
   ```

5. **扫码登录测试**：
   ```
   - 在前端页面点击微信登录按钮
   - 弹出的二维码应能被微信扫描
   - 扫码后应正常接收回调并处理登录
   ```

### 2. 生产环境测试

1. **设置正式环境**：
   ```
   - 使用已备案的域名作为回调地址
   - 确保服务器 IP 不在微信的黑名单中
   ```

2. **测试不同情况**：
   ```
   - 新用户首次登录
   - 已绑定微信的用户再次登录
   - 取消授权的情况
   ```

## 通用测试方法

### 1. 单元测试

编写单元测试来测试登录认证的核心逻辑：

```go
// 谷歌登录测试
func TestGoogleLogin(t *testing.T) {
    // 模拟谷歌认证响应
    // 验证用户创建/查找逻辑
    // 测试 JWT 令牌生成
}

// 微信登录测试
func TestWeixinLogin(t *testing.T) {
    // 模拟微信授权回调
    // 验证用户数据处理
    // 测试会话管理
}
```

### 2. 集成测试

创建集成测试来验证整个登录流程：

```go
// 模拟整个 OAuth 流程
func TestOAuthFlow(t *testing.T) {
    // 启动测试服务器
    // 模拟授权请求和回调
    // 验证用户状态和 token
}
```

### 3. 前端测试工具

1. **使用测试工具模拟 OAuth 提供商**：
   ```
   - Mock Service Worker 可以拦截网络请求并模拟响应
   - Cypress 可以进行端到端测试，模拟整个登录流程
   ```

2. **创建模拟谷歌/微信登录服务**：
   ```
   - 开发一个简单的服务模拟 OAuth 提供商
   - 确保它返回与真实提供商相同格式的响应
   ```

### 4. 安全测试

进行安全测试以确保登录流程的安全性：

```
- 测试 CSRF 防护（验证 state 参数）
- 验证 XSS 漏洞防护
- 检查 token 存储和传输的安全性
```

## 最佳实践建议

1. **创建测试账号**：
   - 在 Google 和微信平台上创建专用的测试账号
   - 避免使用个人账号进行系统测试

2. **监控和日志**：
   - 实现详细的登录流程日志记录
   - 使用监控工具追踪登录成功率和错误情况

3. **回归测试**：
   - 在每次更新后执行登录测试
   - 特别注意 API 变更可能带来的影响

4. **错误处理优化**：
   - 确保友好的错误提示
   - 实现自动重试机制（特别是网络问题）

通过以上方法，你可以全面测试系统的谷歌登录和微信登录功能，确保它们在各种情况下都能正常工作。 